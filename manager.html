<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø± - Ø§Ù„Ù…Ø¯ÙŠØ±</title>
<style>
body {
  font-family: "Cairo", Arial, sans-serif;
  background-color: #eaf3ff;
  margin: 0;
  padding: 0;
}
header {
  text-align: center;
  background: #007bff;
  color: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
header h1 {
  margin: 0;
  font-size: 32px;
}
header h3 {
  margin: 5px 0;
  font-size: 20px;
  font-weight: normal;
}
.container {
  padding: 20px;
  width: 100%;
  max-width: 100%;
  margin: auto;
  box-sizing: border-box;
}
input, select, textarea, button {
  padding: 8px;
  margin: 5px 0;
  width: 100%;
}
button {
  background: #007bff;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  table-layout: auto;
}
th, td {
  border: 1px solid #007bff;
  padding: 8px;
  text-align: center;
  word-break: break-word;
  min-width: 80px;
}
th {
  background: #007bff;
  color: white;
}
#topButtons {
  margin-top: 25px;
  margin-bottom: -5px;
  display: flex;
  justify-content: center;
  gap: 15px;
}
#searchSection {
  margin-top: 20px;
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
form {
  margin-top: 20px;
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
form label {
  font-weight: bold;
  margin-top: 10px;
  display: block;
}
</style>
</head>
<body>

<header>
  <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø±</h1>
  <h3 id="currentUser">Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„: Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
</header>

<div class="container">

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± -->
  <form id="reportForm">
    <h3>Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯</h3>
    <label>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
    <select id="department"></select>
    <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
    <input type="number" id="noteNumber" readonly value="1">
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
    <input type="date" id="noteDate">
    <label>Ø§Ù„ÙØ±Ø¹</label>
    <select id="branch"></select>
    <label>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø¹Ù†ÙŠ</label>
    <select id="employee"></select>
    <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
    <select id="region"></select>
    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
    <select id="noteType"><option>ØªÙ†Ø¨ÙŠÙ‡</option><option>ØªÙ‚Ø±ÙŠØ±</option><option>Ù…Ù„Ø§Ø­Ø¸Ø©</option></select>
    <label>Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
    <textarea id="noteText"></textarea>
    <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
    <input type="number" id="noteAmount">
    <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
    <select id="currency"></select>
    <label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±</label>
    <select id="riskLevel"><option>Ù…Ù†Ø®ÙØ¶</option><option>Ù…ØªÙˆØ³Ø·</option><option>Ù…Ø±ØªÙØ¹</option></select>
    <label>ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø±Ù‚Ø§Ø¨Ø©</label>
    <textarea id="recommendations"></textarea>
    <label>Ù…ÙˆØ¸Ù Ù…Ø®ØªØµ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø©</label>
    <input type="text" id="supervisor">
    <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</label>
    <input type="text" id="treatmentRate">
    <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</label>
    <select id="treatmentStatus"><option>ØºÙŠØ± Ù…Ø¹Ø§Ù„Ø¬Ø©</option><option>Ù…Ø¹Ø§Ù„Ø¬Ø©</option></select>
    <label>Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù</label>
    <input type="file" id="attachment">
    <button type="button" onclick="saveReport()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <button type="button" onclick="window.location.href=' index.html'">Ø±Ø¬ÙˆØ¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>

  </form>

  <!-- Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… -->
  <div id="searchSection">
    <h3>Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…</h3>
    <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
    <select id="searchRegion"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„ÙØ±Ø¹</label>
    <select id="searchBranch"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
    <select id="searchEmployee"><option value="">Ø§Ù„ÙƒÙ„</option></select>
    <label>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
    <input type="text" id="searchUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù†</label>
    <input type="date" id="searchDateFrom">
    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰</label>
    <input type="date" id="searchDateTo">
    <button onclick="searchReports()">Ø¨Ø­Ø«</button>
    <button onclick="fetchReports()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
  </div>

  <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ù„Ø§Ø«Ø© ÙÙˆÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
  <div id="topButtons">
    <button onclick="printReports()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <button onclick="exportExcel()">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
    <button onclick="window.location.href='adduser.html'">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</button>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
  <table id="reportsTable">
    <thead>
      <tr>
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
        <th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
        <th>Ø§Ù„ÙØ±Ø¹</th>
        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
        <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
        <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
        <th>Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
        <th>Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±</th>
        <th>ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø±Ù‚Ø§Ø¨Ø©</th>
        <th>Ù…ÙˆØ¸Ù Ù…Ø®ØªØµ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø©</th>
        <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</th>
        <th>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</th>
        <th>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚</th>
        <th>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwKF-k2_ISY-mjO7tpf60USp1hysMbxvjVi423hg1X2TovVGLLjDCUtoaGB7dmgN0sw/exec"; // Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†

const username = localStorage.getItem("username") || "Ø§Ù„Ù…Ø¯ÙŠØ±";
document.getElementById("currentUser").textContent = "Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„: " + username;

// ==== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙƒÙ…Ø¨ÙˆÙƒØ³Ø§Øª ====
async function loadComboboxData(){
  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify({action:"getComboboxData"})
    });
    const data = await res.json();

    populateSelect("department", data.departments);
    populateSelect("branch", data.branches);
    populateSelect("employee", data.employees);
    populateSelect("region", data.regions);
    populateSelect("currency", data.currencies);

    ["department","branch","employee","region","currency"].forEach(enableSearchable);

    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø£ÙŠØ¶Ø§Ù‹
    populateSelect("searchRegion", data.regions, true);
    populateSelect("searchBranch", data.branches, true);
    populateSelect("searchEmployee", data.employees, true);

  } catch(e) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheet:", e);
  }
}

function populateSelect(id, options, addEmpty=false){
  const select = document.getElementById(id);
  select.innerHTML = "";
  if(addEmpty) select.appendChild(new Option("Ø§Ù„ÙƒÙ„",""));
  options.forEach(opt=>{
    select.appendChild(new Option(opt,opt));
  });
}

function enableSearchable(id){
  const select = document.getElementById(id);
  const wrapper = document.createElement("div");
  wrapper.style.position = "relative";
  select.parentNode.insertBefore(wrapper, select);
  wrapper.appendChild(select);

  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "Ø¨Ø­Ø«...";
  input.style.width = "100%";
  input.style.marginBottom = "5px";
  wrapper.insertBefore(input, select);

  input.addEventListener("input", ()=>{
    const filter = input.value.toLowerCase();
    Array.from(select.options).forEach(opt=>{
      opt.style.display = opt.text.toLowerCase().includes(filter) ? "" : "none";
    });
  });
}

// ==== Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø­ÙØ¸ ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙƒÙ…Ø§ ÙƒØ§Ù† ====
async function saveReport(){
  const report = {
    noteNumber: document.getElementById('noteNumber').value,
    department: document.getElementById('department').value,
    noteDate: document.getElementById('noteDate').value,
    branch: document.getElementById('branch').value,
    employee: document.getElementById('employee').value,
    region: document.getElementById('region').value,
    noteType: document.getElementById('noteType').value,
    noteText: document.getElementById('noteText').value,
    noteAmount: document.getElementById('noteAmount').value,
    currency: document.getElementById('currency').value,
    riskLevel: document.getElementById('riskLevel').value,
    recommendations: document.getElementById('recommendations').value,
    supervisor: document.getElementById('supervisor').value,
    treatmentRate: document.getElementById('treatmentRate').value,
    treatmentStatus: document.getElementById('treatmentStatus').value,
    attachment: document.getElementById('attachment').files[0] ? document.getElementById('attachment').files[0].name : ""
  };

  await fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "addReport", report })
  });

  alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!");
  document.getElementById("noteNumber").value = parseInt(document.getElementById("noteNumber").value) + 1;
  document.getElementById("reportForm").reset();
  fetchReports();
}

async function fetchReports(){
  const res = await fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getReports" })
  });
  const reports = await res.json();
  displayReports(reports);
}

function displayReports(reports){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  reports.forEach((r, index)=>{
    const row = document.createElement("tr");
    r.forEach(value=>{
      const td = document.createElement("td");
      td.textContent = value;
      row.appendChild(td);
    });
    const statusTd = document.createElement("td");
    const select = document.createElement("select");
    ["","Ù…Ø¹ØªÙ…Ø¯","Ù…Ø±ÙÙˆØ¶"].forEach(opt=>{
      const optionEl = document.createElement("option");
      optionEl.value = opt;
      optionEl.textContent = opt;
      if(opt === r[14]) optionEl.selected = true;
      select.appendChild(optionEl);
    });
    select.onchange = ()=>updateStatus(index, select.value);
    statusTd.appendChild(select);
    row.appendChild(statusTd);
    tbody.appendChild(row);
  });
}

async function updateStatus(index, status){
  if(!status) return;
  await fetch(WEB_APP_URL,{
    method:"POST",
    body: JSON.stringify({action:"updateStatus", row:index, status:status})
  });
}

function searchReports(){
  const region = document.getElementById("searchRegion").value;
  const branch = document.getElementById("searchBranch").value;
  const employee = document.getElementById("searchEmployee").value;
  const user = document.getElementById("searchUser").value;
  const dateFrom = document.getElementById("searchDateFrom").value;
  const dateTo = document.getElementById("searchDateTo").value;
  const rows = Array.from(document.getElementById("tableBody").rows);
  rows.forEach(row=>{
    const rowRegion = row.cells[5].textContent;
    const rowBranch = row.cells[3].textContent;
    const rowEmployee = row.cells[4].textContent;
    const rowUser = row.cells[4].textContent;
    const rowDate = row.cells[2].textContent;
    let show = true;
    if(region && rowRegion!==region) show=false;
    if(branch && rowBranch!==branch) show=false;
    if(employee && rowEmployee!==employee) show=false;
    if(user && rowUser.indexOf(user)===-1) show=false;
    if(dateFrom && rowDate<dateFrom) show=false;
    if(dateTo && rowDate>dateTo) show=false;
    row.style.display = show ? "" : "none";
  });
}

function printReports(){ window.print(); }
function exportExcel(){
  let table = document.getElementById("reportsTable");
  let html = table.outerHTML;
  let url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
  let a = document.createElement('a'); a.href = url; a.download = 'Reports.xls'; a.click();
}

window.onload = ()=>{
  fetchReports();
  loadComboboxData();
};
</script>

</body>
</html>
